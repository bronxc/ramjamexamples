
****************************************************************************
	SECTION	exe000000,CODE_C
ProgStart:
	MOVEM.L	D1-D7/A0-A6,-(SP)
	MOVEA.L	4,A6
	JSR	-$84(A6)
	LEA	GFX(PC),A1
	MOVEQ	#0,D0
	JSR	-$228(A6)
	TST.L	D0
	beq.w	GFXERR
	MOVEA.L	D0,A1
	LEA	SYSINFO(PC),A5
	MOVE.L	$26(A1),8(A5)
	MOVE.L	$32(A1),12(A5)
	JSR	-$19E(A6)
	LEA	$DFF000,A6
	BTST	#6,2(A6)
BW__001:
	BTST	#6,2(A6)
	BNE.S	BW__001
VB1__002:
	BTST	#0,5(A6)
;	BEQ.S	VB1__002
VB2__002:
	BTST	#0,5(A6)
;	BNE.S	VB2__002
	MOVE.W	$1C(A6),(A5)
	MOVE.W	2(A6),2(A5)
	MOVE.W	#$7FFF,$9A(A6)
	MOVE.W	#$7FFF,$96(A6)
	MOVE.L	$6C,4(A5)
	bsr.w	_BOOT
	LEA	$DFF000,A6
	LEA	SYSINFO(PC),A5
	MOVE.L	4(A5),$6C
	MOVE.L	8(A5),$80(A6)
	MOVE.L	12(A5),$84(A6)
	MOVE.W	(A5),D0
	ORI.W	#$C000,D0
	MOVE.W	D0,$9A(A6)
	MOVE.W	2(A5),D0
	ORI.W	#$8100,D0
	MOVE.W	D0,$96(A6)
GFXERR:
	MOVEA.L	4,A6
	JSR	-$8A(A6)
	MOVEM.L	(SP)+,D1-D7/A0-A6
	MOVEQ	#0,D0
	RTS

GFX:
	dc.b	'graphics.library',0,0
SYSINFO:
	dcb.l	$4,0

LOADPOINTERS:
	MOVEM.L	D0/D1/A0/A1,-(SP)
	SUBQ.L	#1,D1
	MOVE.L	A0,D0
NXTPLANE:
	MOVE.W	D0,4(A1)
	SWAP	D0
	MOVE.W	D0,(A1)
	SWAP	D0
	ADD.L	D2,D0
	ADDQ.L	#8,A1
	DBRA	D1,NXTPLANE
	MOVEM.L	(SP)+,D0/D1/A0/A1
	RTS

_BOOT:
	LEA	$DFF000,A6
VB1__003:
	BTST	#0,5(A6)
;	BEQ.S	VB1__003
VB2__003:
	BTST	#0,5(A6)
;	BNE.S	VB2__003
	MOVE.W	#$87C0,$96(A6)
	BSR.S	SETCOPPER
	MOVE.L	#MY_COPPER,$80(A6)
	MOVE.W	D0,$88(A6)
	move.w	#0,$1fc(a6)
	MOVE.L	#MY_VBI,$6C
	MOVE.L	#$C0207FFF,$9A(A6)
MLP:
	bsr.w	DBUFFER
	bsr.w	DOANIM
	bsr.w	PLOTPOLYS
	bsr.w	FILLVPLANE
	CMPI.W	#2,ANIMPOS
	BEQ.S	QUIT
	BTST	#6,$BFE001
	BNE.S	MLP
QUIT:
	RTS

MY_VBI:
	MOVEM.L	D0-D7/A0-A6,-(SP)
	LEA	$DFF000,A6
	MOVE.W	#$4020,$9C(A6)
	MOVEM.L	(SP)+,D0-D7/A0-A6
	RTE

SETCOPPER:
	LEA	SCREEN,A0
	LEA	PLPTR1(PC),A1
	MOVEQ	#2,D1
	MOVE.W	#$2C,D2
	bsr.w	LOADPOINTERS
	RTS

MY_COPPER:
	dc.l	$8E2A71,$9036D1,$920030,$9400D8,$1002200,$1020000
	dc.l	$1040000,$108002C,$10A002C
	dc.w	$180
COLPTR1:
	dc.w	0,$182,$855,$184,$585,$186,$558,$E0
PLPTR1:
	dc.w	0,$E2,0,$E4,0,$E6,0,$FFFF,$FFFE

DBUFFER:
	BTST	#6,2(A6)
BW__004:
	BTST	#6,2(A6)
	BNE.S	BW__004
	MOVE.L	D0,-(SP)
CP__005:
	MOVE.L	4(A6),D0
	ROR.L	#8,D0
	CMP.W	#$138,D0
	BNE.S	CP__005
	MOVE.L	(SP)+,D0
	CMPI.L	#SCREEN,VECTPLPTR
	BEQ.S	DBUFFSCRN2
	MOVEA.L	#SCREEN2,A0
	MOVE.L	#SCREEN,VECTPLPTR
	BRA.S	DBUFFPUTIT

DBUFFSCRN2:
	MOVE.L	#SCREEN2,VECTPLPTR
	MOVEA.L	#SCREEN,A0
DBUFFPUTIT:
	LEA	PLPTR1(PC),A1
	MOVEQ	#2,D1
	MOVE.W	#$2C,D2
	bsr.w	LOADPOINTERS
	MOVEA.L	VECTPLPTR,A0
	BTST	#6,2(A6)
BW__006:
	BTST	#6,2(A6)
	BNE.S	BW__006
	MOVE.L	#$1000000,$40(A6)
	MOVE.W	#0,$66(A6)
	MOVE.L	A0,$54(A6)
	MOVE.W	#$4316,$58(A6)
	LEA	$2E10(A0),A0
	BTST	#6,2(A6)
BW__007:
	BTST	#6,2(A6)
	BNE.S	BW__007
	MOVE.L	#$1000000,$40(A6)
	MOVE.W	#0,$66(A6)
	MOVE.L	A0,$54(A6)
	MOVE.W	#$42D6,$58(A6)
	RTS

FILLVPLANE:
	BTST	#6,2(A6)
BW__008:
	BTST	#6,2(A6)
	BNE.S	BW__008
	MOVE.L	#$9F00012,$40(A6)
	MOVE.L	#$FFFFFFFF,$44(A6)
	MOVE.L	#0,$64(A6)
	MOVE.L	VECTPLPTR,D0
	ADDI.L	#$5C1E,D0
	MOVE.L	D0,$50(A6)
	MOVE.L	D0,$54(A6)
	MOVE.W	#$8616,$58(A6)
	RTS

DOANIM:
	LEA	SRCCOORDS(PC),A0
	LEA	POINTLIST(PC),A1
DOANIMLP:
	MOVEM.W	(A0)+,D1/D2
	CMP.W	#$8000,D1
	BEQ.S	DOANIM_FIN
	MULS.W	#$400,D1
	MULS.W	#$400,D2
	MOVE.W	VECTSIZE,D4
	DIVS.W	D4,D1
	DIVS.W	D4,D2
	ADD.W	XCENTRE,D1
	ADD.W	YCENTRE,D2
	MOVE.W	D1,(A1)+
	MOVE.W	D2,(A1)+
	BRA.S	DOANIMLP

DOANIM_FIN:
	TST.W	ANIMPOS
	BNE.S	NMODE0
	CMPI.W	#$400,VECTSIZE
	BGE.S	NMODE0
	ADDQ.W	#8,VECTSIZE
	RTS

NMODE0:
	MOVE.W	#1,ANIMPOS
	SUBQ.W	#1,ANIMPAUSECNT
	BNE.S	lbC00033C
	MOVE.W	#1,ANIMPAUSECNT
	CMPI.W	#$13E,YCENTRE
	BNE.S	ANIMVOUT
	MOVE.W	#2,ANIMPOS
lbC00033C:
	RTS

ANIMVOUT:
	ADDQ.W	#1,YCENTRE
	RTS

PLOTPOLYS:
	BTST	#6,2(A6)
BW__009:
	BTST	#6,2(A6)
	BNE.S	BW__009
	MOVE.L	#$FFFFFFFF,$44(A6)
	MOVE.L	#$FFFF8000,$72(A6)
	MOVE.W	#$58,$60(A6)
	LEA	POINTLIST(PC),A4
	LEA	POLYPTRLIST(PC),A5
	LEA	EDGEDLIST(PC),A2
POLYCHK:
	MOVEA.L	(A5)+,A1
	CMPA.L	#$8000,A1
	BNE.S	ISAPOLY
	RTS

ISAPOLY:
	bsr.w	PROCPOLYIN
	MOVEA.L	(A5)+,A1
	CMPA.L	#$8000,A1
	BNE.S	ISAPOLY
POLYPRINTFIN:
	MOVE.W	#$8000,(A2)
	LEA	EDGEDLIST(PC),A2
DOPOLYEDGELP:
	MOVEM.W	(A2)+,D0/D1
	CMP.W	#$8000,D0
	BEQ.S	POLYEDGESDONE
	MOVE.W	(A2)+,POLYSHADE
	MOVEM.W	(A2)+,D2/D3
	ADDQ.L	#2,A2
	bsr.w	FLINE
	CMPI.W	#$8000,(A2)
	BNE.S	DOPOLYEDGELP
POLYEDGESDONE:
	RTS

POLYSHADE:
	dc.w	0

PROCPOLYIN:
	MOVE.W	(A1)+,POLYSHADE
PROCPOLY:
	MOVEM.W	(A1)+,D1/D3
	CMP.W	#$8001,D1
	BNE.S	PP_GETPTS
	RTS

PP_GETPTS:
	ADD.W	D1,D1
	ADD.W	D1,D1
	ADD.W	D3,D3
	ADD.W	D3,D3
	MOVEM.W	0(A4,D1.W),D0/D1
	MOVEM.W	0(A4,D3.W),D2/D3
	CMP.L	D0,D2
	BGT.S	PP_DIRNOK
	EXG	D2,D0
	EXG	D3,D1
PP_DIRNOK:
	CMP.L	#$160,D2
	BLT.S	CLIP_ROK
	CMP.L	#$15F,D0
	BGT.S	PROCPOLY
	MOVE.L	D1,D7
	SUB.L	D3,D7
	MOVE.L	#$160,D6
	SUB.L	D0,D6
	MULS.W	D6,D7
	MOVE.L	D2,D6
	SUB.L	D0,D6
	BEQ.S	PROCPOLY
	DIVS.W	D6,D7
	EXT.L	D7
	MOVE.L	D1,D3
	SUB.L	D7,D3
	MOVE.L	#$15F,D2
	MOVE.W	D2,(A2)+
	MOVE.W	D3,(A2)+
	MOVE.W	POLYSHADE,(A2)+
CLIP_ROK:
	CMP.L	#0,D0
	BGT.S	CLIP_LOK
	CMP.L	#0,D2
	BLT.S	PROCPOLY
	MOVE.L	D3,D7
	SUB.L	D1,D7
	MOVE.L	D2,D6
	SUB.L	D0,D6
	BEQ.S	PROCPOLY
	MULS.W	D2,D7
	DIVS.W	D6,D7
	EXT.L	D7
	MOVE.L	D3,D1
	SUB.L	D7,D1
	MOVEQ	#0,D0
CLIP_LOK:
	CMP.L	D1,D3
	BGT.S	DIRNOK2
	EXG	D2,D0
	EXG	D3,D1
DIRNOK2:
	CMP.L	#0,D1
	BGT.S	CLIP_TOK
	CMP.L	#0,D3
	BLT.w	PROCPOLY
	MOVE.L	D2,D7
	SUB.L	D0,D7
	MOVE.L	D3,D6
	SUB.L	D1,D6
	beq.w	PROCPOLY
	MULS.W	D3,D7
	DIVS.W	D6,D7
	EXT.L	D7
	MOVE.L	D2,D0
	SUB.L	D7,D0
	MOVEQ	#0,D1
CLIP_TOK:
	CMP.L	#$10B,D3
	BLS.S	CLIP_BOK
	CMP.L	#$10B,D1
	bgt.w	PROCPOLY
	MOVE.L	D0,D7
	SUB.L	D2,D7
	MOVE.L	#$10B,D6
	SUB.L	D1,D6
	MULS.W	D6,D7
	MOVE.L	D3,D6
	SUB.L	D1,D6
	beq.w	PROCPOLY
	DIVS.W	D6,D7
	EXT.L	D7
	MOVE.L	D0,D2
	SUB.L	D7,D2
	MOVE.L	#$10B,D3
CLIP_BOK:
	BSR.S	FLINE
	bra.w	PROCPOLY

FLINE:
	MOVE.W	#$58,D5
	MOVEA.L	VECTPLPTR,A0
	CMP.W	D1,D3
	BGT.S	FLINE_DIRN
	EXG	D2,D0
	EXG	D3,D1
	beq.w	SKIPLINE
FLINE_DIRN:
	MOVE.W	D1,D4
	MULS.W	D5,D4
	MOVE.W	D0,D5
	ADD.L	A0,D4
	ASR.W	#3,D5
	ADD.W	D5,D4
	MOVEQ	#0,D5
	SUB.W	D1,D3
	SUB.W	D0,D2
	BPL.S	FL_1
	MOVEQ	#1,D5
	NEG.W	D2
FL_1:
	MOVE.W	D3,D1
	ADD.W	D1,D1
	CMP.W	D2,D1
	DBHI	D3,FL_FIX
FL_FIX:
	MOVE.W	D3,D1
	SUB.W	D2,D1
	BPL.S	FL_2
	EXG	D3,D2
FL_2:
	ADDX.W	D5,D5
	ADD.W	D2,D2
	MOVE.W	D2,D1
	SUB.W	D3,D2
	ADDX.W	D5,D5
	ANDI.W	#15,D0
	ROR.W	#4,D0
	ORI.W	#$A6A,D0
	MOVE.W	POLYSHADE,D7
	BTST	#6,2(A6)
BW__010:
	BTST	#6,2(A6)
	BNE.S	BW__010
	MOVE.W	D2,$52(A6)
	SUB.W	D3,D2
	LSL.W	#6,D3
	ADDQ.W	#2,D3
	MOVE.W	D0,$40(A6)
	MOVE.B	FLINE_CODES(PC,D5.W),$43(A6)
	MOVE.L	D4,$48(A6)
	MOVE.L	D4,$54(A6)
	MOVEM.W	D1/D2,$62(A6)
	BTST	#0,D7
	BEQ.S	FLINE_NOPL1
	MOVE.W	D3,$58(A6)
FLINE_NOPL1:
	ADDI.W	#$2C,D4
	BTST	#1,D7
	BEQ.S	SKIPLINE
	BTST	#6,2(A6)
BW__011:
	BTST	#6,2(A6)
	BNE.S	BW__011
	MOVE.W	D0,$40(A6)
	MOVE.L	D4,$48(A6)
	MOVE.L	D4,$54(A6)
	MOVE.W	D3,$58(A6)
SKIPLINE:
	RTS

FLINE_CODES:
	dc.b	3,$43,$13,$53,11,$4B,$17,$57
ANIMPAUSECNT:
	dc.w	$19
ANIMPOS:
	dc.w	0
VECTSIZE:
	dc.w	$100
XCENTRE:
	dc.w	$B0
YCENTRE:
	dc.w	$86
POLYPTRLIST:
	dc.l	POLY1,$8000
POLY1:
	dc.w	2,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11
	dc.w	11,12,12,13,13,14,14,15,15,0,$8001
SRCCOORDS:
	dc.w	$FFEC,0,$FFD8,$14,$FFD8,$28,$FFEC,$28,0,$14,$14
	dcb.w	$4,$28
	dcb.w	$2,$14
	dc.w	0,$28,$FFEC,$28,$FFD8,$14,$FFD8,0,$FFEC,$FFEC
	dcb.w	$4,$FFD8
	dc.w	$FFEC,$8000
POINTLIST:
	dcb.l	$3F,0
	dcb.l	$25,0
EDGEDLIST:
	dcb.l	$3F,0
	dcb.l	$3F,0
	dcb.l	$3F,0
	dcb.l	$3F,0
	dcb.l	$30,0
VECTPLPTR:
	dc.l	SCREEN

	SECTION	exe000C5C,BSS_c
	ds.l	$16
SCREEN:
	ds.l	$1708
SCREEN2:
	ds.l	$171E
	end
